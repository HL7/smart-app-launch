resourceType: StructureDefinition
id: patient-access-endpoint

url: >-
  http://hl7.org/fhir/smart-app-launch/StructureDefinition/patient-access-endpoint

name: PatientAccessEndpoint
title: Patient Access Endpoint Profile
status: active
date: '2023-03-03'

description: |
   Profile on Endpoint associated with a Patient Access Brand (Organization):
   **TODO Name this something else? like Patient Access Brands Endpoint**

   The following *Mandatory* (min =1) elements are defined:

    * One or more `extensions` to convey the endpoint's FHIR Version. This element is a denormalization to help clients focus on supported endpoints. The `valueCode` is any version from http://hl7.org/fhir/valueset-FHIR-version.html. (As of this publication, `4.0.1` is expected for ONC-certified EHRs). The *Mandatory* (min =1) Extension sub-elements are:
      *  An 'url' = `http://fhir.org/argonaut/StructureDefinition/endpoint-fhir-version`
      *  A `valueCode`: any version from http://hl7.org/fhir/valueset-FHIR-version.html. (As of this publication, `4.0.1` is expected for ONC-certified EHRs).
    * A `status`
    * A `connectionType`: a fixed Coding for "hl7-fhir-rest"
    * A `managingOrganization`: references to a [Patient Access Brand (Organization)](StructureDefinition-PatientAccessBrand.html). This property associates a single "primary brand" with the endpoint. Additional affiliated Brands or parent brands can be associated via "Patient access provided by" links (`Organization.partOf`). **EHR vendors SHALL support integrated publication of Organizations in the same JSON Bundle, as well as external customer-managed publication. TODO what does this mean** The following *[Must Support](brands.html#must-support-definition-ms-and-data-absent-reasons)* (min = 0) `managingOrganization` sub-elements are:
      * One or more `extensions` URL for a customer-managed Patient Access Brands Bundle that defines the identified Brand and related Brands (**the Bundle SHALL contain exactly one entry matching the specified identifier - TODO does this need an invariant?**). The *Mandatory* (min =1) Extension sub-elements are:
          *  An `url` `http://fhir.org/argonaut/StructureDefinition/brand-bundle`
          *  A `valueUrl` 
      * A `reference`:  a relative URL to a Brand within this Bundle
      * An `identifier`: customer-supplied identifier for the primary Brand
    * `contact`: website where developers can to configure access to this endpoint. The *Mandatory* (min =1) `contact` sub-elements are:
        * A `system` = "url"
        * A `value`: an `https://` URL for app developers
    * A `payloadType`: a fixed Coding for "none"
    *  An `address`: FHIR base URL for server supporting patient access

   The following *[Must Support](brands.html#must-support-definition-ms-and-data-absent-reasons)* (min = 0) elements are defined:

    *  A `name`: fallback or default name describing the endpoint and the organization offering Patient API access at this endpoint. This value MAY contain technical details like FHIR API Version designations, and apps SHOULD preferentially use names from an associated `PatientAccessBrand`, rather than displaying this value to users.


fhirVersion: 4.0.1

kind: resource
abstract: false
type: Endpoint
baseDefinition: 'http://hl7.org/fhir/StructureDefinition/Endpoint'
derivation: constraint


differential:
  element:
    - id: Endpoint
      path: Endpoint
      short: Patient Access Endpoint
      definition: Endpoint associated with a Patient Access Brand (Organization)
    # - id: Endpoint.meta.lastUpdated
    #   path: Endpoint.meta.lastUpdated
    #   min: 1
    # - id: Endpoint.extension
    #   path: Endpoint.extension
      # slicing:
      #   discriminator:
      #     - type: value
      #       path: url
      #   ordered: false
      #   rules: open
    - id: 'Endpoint.extension:fhir-version'
      path: Endpoint.extension
      sliceName: fhir-version
      short: Endpoint FHIR Version
      min: 1
      max: '*'
      type:
        - code: Extension
          profile:
            - >-
              http://hl7.org/fhir/smart-app-launch/StructureDefinition/patient-access-endpoint-fhir-version
      mustSupport: true

    - id: Endpoint.status
      path: Endpoint.status
      mustSupport: true

    - id: Endpoint.connectionType
      path: Endpoint.connectionType
      patternCoding:
        system: 'http://terminology.hl7.org/CodeSystem/endpoint-connection-type'
        code: hl7-fhir-rest
      mustSupport: true

    - id: Endpoint.name
      path: Endpoint.name
      definition: >-
        Fallback or default name describing the endpoint and the organization offering Patient API access at this endpoint. This value MAY contain technical details like FHIR API Version designations, and apps SHOULD preferentially use the name from an associated PatientAccessBrand, rather than displaying this value to users.
      # mustSupport: true

    - id: Endpoint.managingOrganization
      path: Endpoint.managingOrganization
      short: Reference to a PatientAccessBrand Organization.
      definition: >-
        This property associates a single “primary brand” with the endpoint. Additional affiliated Brands or parent brands can be associated via “Patient access provided by” links (Organization.partOf). EHR vendors SHALL support integrated publication of Organizations in the same JSON Bundle, as well as external customer-managed publication.
      min: 1
      type:
        - code: Reference
          targetProfile:
            - 'http://hl7.org/fhir/smart-app-launch/StructureDefinition/patient-access-brand'
          aggregation:
            - bundled
      mustSupport: true


    - id: Endpoint.managingOrganization.extension:brand-bundle
      path: Endpoint.managingOrganization.extension
      short: URL for a customer-managed Patient Access Brands Bundle
      sliceName: brand-bundle
      definition: >-
        URL for a customer-managed Patient Access Brands Bundle that defines the identified Brand and related Brands (the Bundle SHALL contain exactly one entry matching the specified identifier).
      type:
        - code: Extension
          profile:
            - 'http://hl7.org/fhir/smart-app-launch/StructureDefinition/patient-access-endpoint-brand-bundle'
      mustSupport: true

    - id: Endpoint.managingOrganization.reference
      path: Endpoint.managingOrganization.reference
      short: Relative URL to a Brand within the Patient Access Brands Bundle
      definition: >-
        Relative URL to a Brand within the Patient Access Brands Bundle

      mustSupport: true

    - id: Endpoint.managingOrganization.identifier
      path: Endpoint.managingOrganization.identifier
      short: Customer-supplied identifier for the primary Brand
      definition: >-
        Customer-supplied identifier for the primary Brand
      mustSupport: true

    - id: Endpoint.contact
      path: Endpoint.contact
      short: Contact information for the endpoint.
      definition: >-
        Contact information for the endpoint.
      slicing:
        discriminator:
          - type: value
            path: system
        rules: open
      mustSupport: true

    - id: Endpoint.contact:configuration-url
      path: Endpoint.contact
      sliceName: configuration-url
      short: Website where developers can to configure access to this endpoint
      definition: >-
        Contact information for the endpoint. This is the website where developers can to configure access to this endpoint.
      min: 1
      mustSupport: true

    - id: Endpoint.contact:configuration-url.system
      path: Endpoint.contact.system
      fixedCode: url
      min: 1
      mustSupport: true

    - id: Endpoint.contact:configuration-url.value
      path: Endpoint.contact.value
      short: an https:// URL for app developers
      definition: >-
        an `https://` URL for app developers
      min: 1
      mustSupport: true

    - id: Endpoint.payloadType
      path: Endpoint.payloadType
      max: '1'
      patternCodeableConcept:
        coding:
          - system: 'http://terminology.hl7.org/CodeSystem/endpoint-payload-type'
            code:  none
      mustSupport: true
    #   binding:
    #     strength: extensible
    #     valueSet: >-
    #       http://hl7.org/fhir/us/davinci-pdex-plan-net/ValueSet/EndpointPayloadTypeVS

    # - id: Endpoint.payloadMimeType
    #   path: Endpoint.payloadMimeType
    #   mustSupport: true

    - id: Endpoint.address
      path: Endpoint.address
      short: FHIR base URL for servers supporting patient access
      min: 1
      max: '1'
      mustSupport: true